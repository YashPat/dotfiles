name: Test link-dotfiles

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-link-dotfiles:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run link-dotfiles.sh
        env:
          HOME: ${{ github.workspace }}/test-home
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p "$HOME/.config"
          bash link-dotfiles.sh

      - name: Verify symlinks
        env:
          HOME: ${{ github.workspace }}/test-home
          REPO: ${{ github.workspace }}
        run: |
          check_link() {
            local dst="$1" expected_src="$2"
            if [[ ! -L "$dst" ]]; then
              echo "FAIL: $dst is not a symlink"
              exit 1
            fi
            target=$(readlink -f "$dst")
            expected_canonical=$(readlink -f "$expected_src")
            if [[ "$target" != "$expected_canonical" ]]; then
              echo "FAIL: $dst points to $target, expected $expected_canonical"
              exit 1
            fi
            echo "OK $dst -> $target"
          }
          check_link "$HOME/.zshrc" "$REPO/zshrc"
          check_link "$HOME/.gitconfig" "$REPO/gitconfig"
          check_link "$HOME/.config/kitty/kitty.conf" "$REPO/kitty.conf"
          check_link "$HOME/.config/starship.toml" "$REPO/starship.toml"
          echo "All symlinks verified."

  test-bootstrap-fails-on-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: bootstrap.sh exits with macOS-only message on Linux
        run: |
          out=$(bash bootstrap.sh 2>&1); code=$?
          if [[ $code -eq 1 ]] && echo "$out" | grep -q "bootstrap.sh is for macOS only"; then
            echo "OK: bootstrap.sh correctly refuses to run on Linux"
          else
            echo "FAIL: expected exit 1 and macOS-only message. Exit code: $code"
            echo "$out"
            exit 1
          fi
